<div class="card" style=" min-height: 77vh">
    <p-toast position="top-center" class="custom-toast"></p-toast>
    <h2 class="text-3xl font-bold mb-6">Journal Entries</h2>

    <!-- أزرار البحث والإضافة -->
    <div class="flex flex-wrap items-center gap-4 mb-4">
        <button pButton label="New Entry" icon="pi pi-plus" class="p-button-success"
            (click)="openNewJournal()"outlined></button>

        <div class="flex items-center gap-2">
            <input type="text" pInputText placeholder="Search her...." [(ngModel)]="journalIdFilter"
                class="p-inputtext w-40">
        </div>

    </div>
    <p-table [value]="filteredJournals(journalIdFilter)" [paginator]="true" [rows]="10" [responsiveLayout]="'scroll'"
        [scrollable]="true" scrollHeight="400px">

        <ng-template pTemplate="header">
            <tr class="bg-gray-100 sticky top-0 z-10">
                <th>#</th>
                <th>Date</th>
                <th>Total Debit</th>
                <th>Total Credit</th>
                <th>Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-journal let-i="rowIndex">
            <tr>
                <td>{{ journal.entryNumber }}</td>
                <td>{{journal.date | date:'yyyy-MM-dd'}}</td>
                <td>{{journal.totalDebit | number:'1.2-2'}}</td>
                <td>{{journal.totalCredit | number:'1.2-2'}}</td>
                <td class="flex gap-2">
                    <button pButton icon="pi pi-pencil" class="p-button-info "outlined
                        (click)="editJournal(journal)"></button>
                    <button pButton icon="pi pi-trash" class="p-button-danger "outlined
                        (click)="deleteJournal(i, journal.id)"></button>

                    <button pButton icon="pi pi-print" class="p-button-warning "outlined
                        (click)="printEntry(journalEntries[i])"></button>
                </td>
            </tr>
        </ng-template>


    </p-table>



    <p-dialog header="{{isEdit ? 'Edit Entry' : 'New Entry'}}" [(visible)]="displayDialog" [modal]="true"
        [style]="{width:'90vw', height:'90vh'}"  [closable]="true">

        <div class="flex flex-col h-full bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">

            <!-- ======= الهيدر ======= -->
            <div class="border-b border-gray-200 dark:border-gray-700  grid grid-cols-12 gap-6 items-center">

                <div class="col-span-3 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-1">Entry No.</label>

                    <input type="text" [(ngModel)]="currentJournal.entryNumber"
                        class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                        readonly>

                </div>


                <div class="col-span-2 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Date</label>
                    <p-datepicker [(ngModel)]="currentJournal.date" [showIcon]="true"
                        inputStyleClass="w-full px-3 py-2 rounded-md bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"></p-datepicker>
                </div>

                <div class="col-span-2 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Status</label>
                    <select [(ngModel)]="currentJournal.status"
                        class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>

                <div class="col-span-2 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Entry Type</label>
                    <select [(ngModel)]="currentJournal.type"
                        class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
                        <option value="Daily">Daily</option>
                        <option value="Adjustment">Adjustment</option>
                        <option value="Closing">Closing</option>
                    </select>
                </div>

                <div class="col-span-3 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Summary</label>
                    <input type="text"
                        [value]="(currentJournal.totalDebit + currentJournal.totalCredit) | number:'1.2-2'"
                        class="p-inputtext w-full text-right font-semibold rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                        readonly>
                </div>

                <div class="col-span-12 mt-4 flex flex-col">
                    <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Notes</label>
                    <textarea [(ngModel)]="currentJournal.description"
                        class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                        rows="3" placeholder="Add notes..."></textarea>
                </div>

            </div>

            <!-- ======= الجدول ======= -->
          <div class="flex-1 overflow-auto
            min-h-[40vh]
            sm:min-h-[45vh]
            md:min-h-[55vh]
            lg:min-h-[57vh]">

                <p-table [value]="currentJournal.entries" [scrollable]="true" scrollHeight="100%" selectionMode="single"
                    [(contextMenuSelection)]="selectedLine" [contextMenu]="cm" class="fixed-rows-table w-full">

                    <ng-template pTemplate="header">
                        <tr class="bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
                            <th>#</th>
                            <th>Account Code</th>
                            <th>Account Name</th>
                            <th>Vendor</th>
                            <th>Description</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Cost Center</th>
                            <th>Tags</th>
                            <th>Action</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-line let-i="rowIndex">
                        <tr (click)="selectedRowIndex=i" class="hover:bg-gray-200 dark:hover:bg-gray-600">
                            <td>{{ i + 1 }}</td>

                            <!-- رقم الحساب -->
                            <td>
                                <input type="text" [(ngModel)]="line.accountCode"
                                    (input)="handleAccountInput($event, i)" (keydown)="openAccountSearch($event, i)"
                                    (keydown.enter)="addNewLine(i); $event.preventDefault()"
                                    [class.p-invalid]="line.invalidAccount" placeholder="Account No. or F9 to Search"
                                    class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />
                                <input type="hidden" [(ngModel)]="line.accountId">
                            </td>

                            <!-- اسم الحساب -->
                            <td>
                                <input type="text" [(ngModel)]="line.accountName" placeholder="Account Name" readonly
                                    class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />
                            </td>

                            <!-- Vendor -->
                            <td>
                                <input type="text" [(ngModel)]="line.vendor" (input)="handleVendorInput($event, i)"
                                    (keydown)="openVendorDialog($event, i)" placeholder="Vendor No. or F9 to Search"
                                    [class.p-invalid]="line.invalidVendor"
                                    class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />
                                <input type="hidden" [(ngModel)]="line.entityId">
                                <input type="hidden" [(ngModel)]="line.entityType">
                            </td>

                            <!-- الوصف -->
                            <td>
                                <input type="text" [(ngModel)]="line.description" placeholder="Description"
                                  class="p-inputtext w-[250px] rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"

                                    (keydown.enter)="addNewLine(i); $event.preventDefault()" />
                            </td>

                            <!-- Debit -->
                            <td>
                                <input type="text" [(ngModel)]="line.debit" (focus)="formatWithCommas(line, 'debit')"
                                    (input)="formatWithCommas(line, 'debit'); updateTotals()" placeholder="0.00"
                                    class="p-inputtext w-full text-right bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />
                            </td>

                            <!-- Credit -->
                            <td>
                                <input type="text" [(ngModel)]="line.credit" (focus)="formatWithCommas(line, 'credit')"
                                    (input)="formatWithCommas(line, 'credit'); updateTotals()" placeholder="0.00"
                                    class="p-inputtext w-full text-right bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />
                            </td>

                            <td>
                                <input type="text" [(ngModel)]="line.costCenterName"
                                    (blur)="handleCostCenterInput($event, i)"
                                    (keydown.enter)="handleCostCenterInput($event, i); $event.preventDefault()"
                                    (keydown)="openCostCenterSearch($event, i)" placeholder="CostCenter Code or Name"
                                    [class.p-invalid]="line.invalidCostCenter"
                                    class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200" />

                                <input type="hidden" [(ngModel)]="line.costCenterId">
                                <input type="hidden" [(ngModel)]="line.costCenterCode">
                            </td>


                            <!-- Tags -->
                            <td>
                                <p-multiSelect [options]="tags" [(ngModel)]="line.tags" optionLabel="name"
                                    display="chip" defaultLabel="Select tags" [filter]="true"
                                    styleClass="dark:text-white dark:bg-gray-700"></p-multiSelect>
                            </td>

                            <!-- Action -->
                            <td>
                                <button pButton icon="pi pi-trash" class="p-button p-button-danger"
                                    (click)="removeJournalLine(i)"outlined></button>
                            </td>
                        </tr>
                    </ng-template>

                </p-table>
            </div>


            <p-contextMenu #cm [model]="contextMenuItems"></p-contextMenu>
            
           <!-- ======= الفوتر ======= -->
<div
    class="border-t border-gray-200 dark:border-gray-700 pt-1 pb-1 px-5 
           flex items-center justify-between bg-gray-60 dark:bg-gray-800">

    <!-- يسار = القيم -->
    <div class="flex-1 flex flex-col gap-1 text-left font-bold text-gray-700 dark:text-gray-300">

        <div class="flex justify-between w-48">
            <span>Difference:</span>
            <span [ngClass]="{
                'text-green-600': currentJournal.totalDebit > currentJournal.totalCredit,
                'text-red-600': currentJournal.totalDebit < currentJournal.totalCredit,
                'text-gray-700 dark:text-gray-300': currentJournal.totalDebit === currentJournal.totalCredit
            }">
                {{ (currentJournal.totalDebit - currentJournal.totalCredit) | number:'1.2-2' }}
            </span>
        </div>

        <div class="flex justify-between w-48">
            <span>Total Debit:</span>
            <span>{{ currentJournal.totalDebit | number:'1.2-2' }}</span>
        </div>

        <div class="flex justify-between w-48">
            <span>Total Credit:</span>
            <span>{{ currentJournal.totalCredit | number:'1.2-2' }}</span>
        </div>

    </div>

    <!-- وسط = الرسالة -->
    <div class="flex-1 flex justify-center items-center">
        <div *ngIf="!isBalanced()" class="text-red-600 font-bold text-center">
            ⚠️ Debit and Credit must be equal
        </div>
    </div>

    <!-- يمين = الأزرار -->
    <div class="flex-1 flex justify-end gap-2">
        <button pButton label="Cancel" icon="pi pi-times-circle" class="p-button-danger"outlined
            (click)="displayDialog=false"></button>
        <button pButton label="Save" icon="pi pi-save" class="p-button-success"outlined
            (click)="saveJournal()"></button>
    </div>

</div>


        </div>
    </p-dialog>




    <!-- Dialog الموردين -->

    <p-dialog header="Vendors" [(visible)]="vendorDialog" [modal]="true" [style]="{'width':'50vw','height':'450px'}"
        [resizable]="false" [breakpoints]="{'960px':'90vw'}">

        <div class="flex flex-col h-full">

            <!-- الهيدر ثابت -->
            <div class="flex gap-2 mb-2 flex-shrink-0">
                <input type="text" pInputText [(ngModel)]="vendorFilter" placeholder="Search vendor..." class="flex-1"
                    (input)="updateFilteredVendors()">
                <button pButton label="Add Vendor" icon="pi pi-plus" class="p-button-success"
                    (click)="openAddVendor()"></button>
            </div>

            <!-- الجدول scrollable -->
            <div class="flex-1 overflow-auto min-h-[250px]">
                <p-table [value]="filteredVendorList" [scrollable]="true" scrollHeight="100%">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>#</th>
                            <th>Vendor Name</th>
                            <th>Account No</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-vn let-i="rowIndex">
                        <tr style="height:50px" (click)="selectVendor(vn)" class="cursor-pointer hover:bg-gray-200">
                            <td>{{i + 1}}</td>
                            <td>{{vn.name}}</td>
                            <td>{{vn.code}}</td>
                            <td class="flex gap-2">
                                <button pButton icon="pi pi-pencil" class="p-button-sm p-button-info"
                                    (click)="openEditVendor(vn); $event.stopPropagation()"></button>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="4">
                                <div class="flex flex-col items-center justify-center h-full py-10">
                                    <i class="pi pi-database " style="font-size: 2rem"></i>
                                    <span class="text-gray-500 text-lg">No Data Available</span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                </p-table>
            </div>

            <!-- الفوتر ثابت -->
            <div class="flex-shrink-0 mt-2 border-t pt-2 
                bg-white border-gray-200 
                dark:bg-[#18181b] dark:border-gray-700">
                <p-paginator [rows]="5" [totalRecords]="filteredVendorList.length || 0">
                </p-paginator>
            </div>

        </div>
    </p-dialog>


    <!-- Dialog الحسابات -->

    <p-dialog header="Select Account" [(visible)]="accountDialog" [modal]="true"
        [style]="{'width':'50vw','height':'450px'}" [resizable]="false" [breakpoints]="{'960px':'90vw'}">

        <div class="flex flex-col h-full">

            <!-- الهيدر ثابت -->
            <div class="mb-2 flex-shrink-0">
                <input type="text" pInputText [(ngModel)]="accountFilter" placeholder="Search account..." class="w-full"
                    (input)="updateFilteredAccounts()">
            </div>

            <!-- الجدول scrollable -->
            <div class="flex-1 overflow-auto min-h-[250px]">
                <p-table [value]="filteredAccountsList" [scrollable]="true" scrollHeight="100%">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>#</th>
                            <th>Account Name</th>
                            <th>Account No</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-acc let-i="rowIndex">
                        <tr (click)="selectAccount(acc)" class="cursor-pointer hover:bg-gray-200">
                            <td>{{i + 1}}</td>
                            <td>{{acc.name}}</td>
                            <td>{{acc.code}}</td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="3">
                                <div class="flex flex-col items-center justify-center h-full py-10">
                                    <i class="pi pi-database " style="font-size: 2rem"></i>
                                    <span class="text-gray-500 text-lg">No Data Available</span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

            </div>

            <!-- الفوتر ثابت -->
            <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
                <p-paginator [rows]="5" [totalRecords]="filteredVendorList.length || 0">
                </p-paginator>

            </div>


        </div>
    </p-dialog>


    <!-- Dialog مراكز التكلفة -->

    <p-dialog header="Select Cost Center" [(visible)]="costCenterDialog" [modal]="true"
        [style]="{'width':'50vw','height':'450px'}" [resizable]="false" [breakpoints]="{'960px':'90vw'}">

        <div class="flex flex-col h-full">

            <!-- الهيدر ثابت -->
            <div class="mb-2 flex-shrink-0">
                <input type="text" pInputText [(ngModel)]="costCenterFilter" placeholder="Search cost center..."
                    class="w-full" (input)="filteredCostCenters()">
            </div>

            <!-- الجدول scrollable -->
            <div class="flex-1 overflow-auto min-h-[250px]">
                <p-table [value]="filteredCostCentersList" [scrollable]="true" scrollHeight="100%">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>#</th>
                            <th>Cost Center Name</th>
                            <th>Cost Center No</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-cc let-i="rowIndex">
                        <tr style="height:50px" (click)="selectCostCenter(cc)" class="cursor-pointer hover:bg-gray-200">
                            <td>{{i + 1}}</td>
                            <td>{{cc.name}}</td>
                            <td>{{cc.code}}</td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="3">
                                <div class="flex flex-col items-center justify-center h-full py-10">
                                    <i class="pi pi-database" style="font-size: 2rem"></i>
                                    <span class="text-gray-500 text-lg">No Data Available</span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                </p-table>
            </div>

            <!-- الفوتر ثابت -->
            <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
                <p-paginator [rows]="5" [totalRecords]="filteredCostCentersList.length || 0">
                </p-paginator>
            </div>

        </div>
    </p-dialog>



    <!-- Dialog إضافة / تعديل مورد -->

    <p-dialog header="{{isEditVendor ? 'Edit Vendor' : 'Add Vendor'}}" [(visible)]="vendorFormDialog" [modal]="true"
        [style]="{width:'40vw'}" [resizable]="true" [breakpoints]="{'960px':'90vw'}">

        <div class="flex flex-col h-full">

            <!-- محتوى الفورم -->
            <div class="flex-1 overflow-auto">
                <label class="block mb-1 font-semibold">Vendor Name</label>
                <input type="text" pInputText [(ngModel)]="currentVendor.name" class="w-full mb-2">

                <label class="block mb-1 font-semibold">Account No</label>
                <input type="text" pInputText [(ngModel)]="currentVendor.account" class="w-full mb-2">
            </div>

            <!-- الفوتر ثابت -->
            <div class="flex-shrink-0 mt-2 flex justify-end gap-2">
                <button pButton label="Cancel" class="p-button-secondary" (click)="cancelVendor()"></button>
                <button pButton label="Save" class="p-button-success" (click)="saveVendor()"></button>
            </div>

        </div>
    </p-dialog>


    <p-confirmDialog></p-confirmDialog>
</div>