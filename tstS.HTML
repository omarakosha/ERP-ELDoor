import { Component, HostListener } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TableModule } from 'primeng/table';
import { ButtonModule } from 'primeng/button';
import { DialogModule } from 'primeng/dialog';
import { InputTextModule } from 'primeng/inputtext';
import { ConfirmDialogModule } from 'primeng/confirmdialog';
import { ToastModule } from 'primeng/toast';
import { ConfirmationService, MessageService } from 'primeng/api';
import { DatePickerModule } from 'primeng/datepicker';
import { ContextMenuModule } from 'primeng/contextmenu';
import { MultiSelectModule } from 'primeng/multiselect';
import { PaginatorModule } from 'primeng/paginator';








loadAccounts() {
  this.loaderService.show(); // ğŸŸ¢ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ÙˆØ¯Ù†Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨
    this.accountsService.getAccounts().subscribe((accounts: Account[]) => {

      // âœ… Ø¥ØµÙ„Ø§Ø­ children = null â†’ []
      const normalizeChildren = (accs: Account[]) => {
        accs.forEach(a => {
          if (!Array.isArray(a.children)) a.children = []; // ØªØ­ÙˆÙŠÙ„ null Ø¥Ù„Ù‰ []
          
          normalizeChildren(a.children);
        });
      };
      
      normalizeChildren(accounts);

      // âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ TreeNode
      this.accountsTree = this.mapAccountsToTreeNodes(accounts);

      // âœ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø´Ø¬Ø±Ø©
      this.updateLevels(this.accountsTree);

      // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      this.filteredTree = [...this.accountsTree];
    });
    
}














@Component({
  selector: 'app-journal-entries',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    TableModule,
    ButtonModule,
    DialogModule,
    InputTextModule,
    ConfirmDialogModule,
    ToastModule,
    DatePickerModule,
    ContextMenuModule,
    PaginatorModule,
    MultiSelectModule
  ],
  providers: [ConfirmationService, MessageService],
  template: `
 <div class="card">
 <p-toast position="top-center" class="custom-toast"></p-toast>
  <h2 class="text-3xl font-bold mb-6">Journal Entries</h2>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© -->
  <div class="flex flex-wrap items-center gap-4 mb-4">
    <button pButton label="New Entry" icon="pi pi-plus" class="p-button-success"
            (click)="openNewJournal()"></button>

    <div class="flex items-center gap-2">
      <input type="text" pInputText placeholder="Search her...."
             [(ngModel)]="journalIdFilter"
             class="p-inputtext w-40">
    </div>
    
  </div>
<p-table 
  [value]="filteredJournals(journalIdFilter)" 
  [paginator]="true" 
  [rows]="10" 
  [responsiveLayout]="'scroll'" 
  [scrollable]="true" 
  scrollHeight="400px">

  <ng-template pTemplate="header">
    <tr class="bg-gray-100 sticky top-0 z-10">
      <th>#</th>
      <th>Date</th>
      <th>Total Debit</th>
      <th>Total Credit</th>
      <th>Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-journal let-i="rowIndex">
    <tr>
      <td>{{journal.id}}</td>
      <td>{{journal.date | date:'yyyy-MM-dd'}}</td>
      <td>{{journal.totalDebit | number:'1.2-2'}}</td>
      <td>{{journal.totalCredit | number:'1.2-2'}}</td>
      <td class="flex gap-2">
        <button pButton icon="pi pi-pencil" class="p-button-info p-button-sm" (click)="editJournal(journal)"></button>
        <button pButton icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="deleteJournal(i)"></button>
        <button pButton icon="pi pi-print" class="p-button-warning p-button-sm" (click)="printEntry(journal)"></button>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="5">
        <div class="flex flex-col items-center justify-center h-full py-10">
          <i class="pi pi-database" style="font-size: 2rem"></i>
          <span class="text-gray-500 text-lg text-center">
            {{ filteredJournals(journalIdFilter).length ? 'No results found for your search' : 'No Data Available' }}
          </span>
        </div>
      </td>
    </tr>
  </ng-template>

</p-table>



<p-dialog 
    header="{{isEdit ? 'Edit Entry' : 'New Entry'}}"
    [(visible)]="displayDialog" 
    [modal]="true"
    [style]="{width:'90vw', height:'70vh'}" 
    [closable]="false">

  <div class="flex flex-col h-full bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- ======= Ø§Ù„Ù‡ÙŠØ¯Ø± ======= -->
    <div class="border-b border-gray-200 dark:border-gray-700  grid grid-cols-12 gap-6 items-center">

      <div class="col-span-3 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-1">Entry No.</label>
        
        <input type="text"
               [(ngModel)]="currentJournal.id"
               class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
               readonly>
      </div>

      <div class="col-span-2 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Date</label>
        <p-datepicker [(ngModel)]="currentJournal.date"
                      [showIcon]="true"
                      inputStyleClass="w-full px-3 py-2 rounded-md bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"></p-datepicker>
      </div>

      <div class="col-span-2 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Status</label>
        <select [(ngModel)]="currentJournal.status"
                class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Closed">Closed</option>
        </select>
      </div>

      <div class="col-span-2 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Entry Type</label>
        <select [(ngModel)]="currentJournal.type"
                class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
          <option value="Daily">Daily</option>
          <option value="Adjustment">Adjustment</option>
          <option value="Closing">Closing</option>
        </select>
      </div>

      <div class="col-span-3 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Summary</label>
        <input type="text"
               [value]="(currentJournal.totalDebit + currentJournal.totalCredit) | number:'1.2-2'"
               class="p-inputtext w-full text-right font-semibold rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
               readonly>
      </div>

      <div class="col-span-12 mt-4 flex flex-col">
        <label class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Notes</label>
        <textarea [(ngModel)]="currentJournal.notes"
                  class="p-inputtext w-full rounded-md px-3 py-2 bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                  rows="3"
                  placeholder="Add notes..."></textarea>
      </div>

    </div>

    <!-- ======= Ø§Ù„Ø¬Ø¯ÙˆÙ„ ======= -->
    <div class="flex-1 overflow-auto min-h-[320px] mt-2">
      <p-table [value]="currentJournal.entries"
               [scrollable]="true"
               scrollHeight="100%"
               selectionMode="single"
               [(contextMenuSelection)]="selectedLine"
               [contextMenu]="cm"
               class="fixed-rows-table w-full">

        <ng-template pTemplate="header">
          <tr class="bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
            <th>#</th>
            <th>Account</th>
            <th>Vendor</th>
            <th>Description</th>
            <th>Debit</th>
            <th>Credit</th>
            <th>Cost Center</th>
            <th>Tags</th>
            <th>Action</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-line let-i="rowIndex">
          <tr (click)="selectedRowIndex=i" class="hover:bg-gray-200 dark:hover:bg-gray-600">
            <td>{{ i + 1 }}</td>

            <td>
              <input type="text" [(ngModel)]="line.account"
                     (input)="handleAccountInput($event, i)"
                     (keydown)="openAccountSearch($event, i)"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     [class.p-invalid]="line.invalidAccount"
                     [id]="'account-' + i"
                     placeholder="Account No. or F9 to Search"
                     class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
            </td>

            <td>
              <input type="text" [(ngModel)]="line.vendor"
                     (input)="handleVendorInput($event,i)"
                     (keydown)="openVendorDialog($event,i)"
                     [disabled]="!line.isVendorEnabled"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     [class.p-invalid]="line.invalidVendor"
                     placeholder="Vendor No. or F9 to Search"
                     class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
            </td>

            <td>
              <input type="text" [(ngModel)]="line.description"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                     placeholder="Description"
                     style="width: 300px;">
            </td>

            <td>
              <input type="text"
                     [(ngModel)]="line.debit"
                     (focus)="formatWithCommas(line, 'debit')"
                     (input)="formatWithCommas(line, 'debit'); updateTotals()"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     class="p-inputtext w-full text-right bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                     placeholder="0.00">
            </td>

            <td>
              <input type="text"
                     [(ngModel)]="line.credit"
                     (focus)="formatWithCommas(line, 'credit')"
                     (input)="formatWithCommas(line, 'credit'); updateTotals()"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     class="p-inputtext w-full text-right bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200"
                     placeholder="0.00">
            </td>

            <td>
              <input type="text" [(ngModel)]="line.costCenter"
                     (input)="handleCostCenterInput($event,i)"
                     (keydown)="openCostCenterSearch($event,i)"
                     (keydown.enter)="addNewLine(i); $event.preventDefault()"
                     [class.p-invalid]="line.invalidCostCenter"
                     placeholder="CostCenter No. or F9 to Search"
                     class="p-inputtext w-full bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-200">
            </td>

            <td>
              <p-multiSelect [options]="tags" [(ngModel)]="line.tags"
                             optionLabel="name" display="chip"
                             defaultLabel="Select tags" [filter]="true"
                             styleClass="dark:text-white dark:bg-gray-700"
                             (keydown.enter)="addNewLine(i); $event.preventDefault()"></p-multiSelect>
            </td>

            <td>
              <button pButton icon="pi pi-trash" class="p-button p-button-danger p-button-sm"
                      (click)="removeJournalLine(i)"></button>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </div>

    <p-contextMenu #cm [model]="contextMenuItems"></p-contextMenu>

    <!-- ======= Ø§Ù„ÙÙˆØªØ± ======= -->
    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 pb-4 px-5 flex flex-col gap-3 bg-gray-50 dark:bg-gray-800">

      <div class="h-6 flex items-center justify-center">
        <div *ngIf="!isBalanced()" class="text-red-600 font-bold text-center mb-2">
          âš ï¸ Debit and Credit must be equal
        </div>
      </div>

      <div class="flex justify-between items-start">
        <div class="flex flex-col text-left font-bold text-gray-700 dark:text-gray-300">
          <div>Total Debit.: {{currentJournal.totalDebit | number:'1.2-2'}}</div>
          <div>Total Credit: {{currentJournal.totalCredit | number:'1.2-2'}}</div>
        </div>

        <div class="flex gap-2">
          <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary"
                  (click)="displayDialog=false"></button>
          <button pButton label="Save" icon="pi pi-check" class="p-button-success"
                  (click)="saveJournal()"></button>
        </div>
      </div>

    </div>

  </div>
</p-dialog>




<!-- Dialog Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
<p-dialog header="Vendors" [(visible)]="vendorDialog" [modal]="true"
          [style]="{'width':'50vw','height':'450px'}" [resizable]="false"
          [breakpoints]="{'960px':'90vw'}">

  <div class="flex flex-col h-full">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª -->
    <div class="flex gap-2 mb-2 flex-shrink-0">
      <input type="text" pInputText [(ngModel)]="vendorFilter"
             placeholder="Search vendor..." class="flex-1"
             (input)="filteredVendors()">
      <button pButton label="Add Vendor" icon="pi pi-plus"
              class="p-button-success" (click)="openAddVendor()"></button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ scrollable -->
    <div class="flex-1 overflow-auto min-h-[250px]">
      <p-table [value]="filteredVendors()" [scrollable]="true" scrollHeight="100%">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Vendor Name</th>
            <th>Account No</th>
            <th>Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-vn let-i="rowIndex">
          <tr style="height:50px" (click)="selectVendor(vn)" class="cursor-pointer hover:bg-gray-200">
            <td>{{i + 1}}</td>
            <td>{{vn.name}}</td>
            <td>{{vn.account}}</td>
            <td class="flex gap-2">
              <button pButton icon="pi pi-pencil"
                      class="p-button-sm p-button-info"
                      (click)="openEditVendor(vn); $event.stopPropagation()"></button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4">
              <div class="flex flex-col items-center justify-center h-full py-10">
                <i class="pi pi-database " style="font-size: 2rem"></i>
                <span class="text-gray-500 text-lg">No Data Available</span>
              </div>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª -->
 <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
  <p-paginator 
    [rows]="5" 
    [totalRecords]="filteredVendors().length || 0"
   >
  </p-paginator>
</div>


  </div>
</p-dialog>

<!-- Dialog Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
<p-dialog header="Select Account" [(visible)]="accountDialog" [modal]="true"
          [style]="{'width':'50vw','height':'450px'}" [resizable]="false"
          [breakpoints]="{'960px':'90vw'}">

  <div class="flex flex-col h-full">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª -->
    <div class="mb-2 flex-shrink-0">
      <input type="text" pInputText [(ngModel)]="accountFilter"
             placeholder="Search account..." class="w-full"
             (input)="filteredAccounts()">
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ scrollable -->
    <div class="flex-1 overflow-auto min-h-[250px]">
      <p-table [value]="filteredAccounts()" [scrollable]="true" scrollHeight="100%">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Account Name</th>
            <th>Account No</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-acc let-i="rowIndex">
          <tr style="height:50px" (click)="selectAccount(acc)" class="cursor-pointer hover:bg-gray-200">
            <td>{{i + 1}}</td>
            <td>{{acc.name}}</td>
            <td>{{acc.code}}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="3">
              <div class="flex flex-col items-center justify-center h-full py-10">
                <i class="pi pi-database " style="font-size: 2rem"></i>
                <span class="text-gray-500 text-lg">No Data Available</span>
              </div>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª -->
   <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
  <p-paginator 
    [rows]="5" 
    [totalRecords]="filteredVendors().length || 0"
   >
  </p-paginator>
</div>


  </div>
</p-dialog>

<!-- Dialog Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© -->
<p-dialog header="Select Cost Center" [(visible)]="costCenterDialog" [modal]="true"
          [style]="{'width':'50vw','height':'450px'}" [resizable]="false"
          [breakpoints]="{'960px':'90vw'}">

  <div class="flex flex-col h-full">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª -->
    <div class="mb-2 flex-shrink-0">
      <input type="text" pInputText [(ngModel)]="costCenterFilter"
             placeholder="Search cost center..." class="w-full"
             (input)="filteredCostCenters()">
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ scrollable -->
    <div class="flex-1 overflow-auto min-h-[250px]">
      <p-table [value]="filteredCostCenters()" [scrollable]="true" scrollHeight="100%">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Cost Center Name</th>
            <th>Cost Center No</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-cc let-i="rowIndex">
          <tr style="height:50px" (click)="selectCostCenter(cc)" class="cursor-pointer hover:bg-gray-200">
            <td>{{i + 1}}</td>
            <td>{{cc.name}}</td>
            <td>{{cc.code}}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="3">
              <div class="flex flex-col items-center justify-center h-full py-10">
              
                <i class="pi pi-database " style="font-size: 2rem"></i>
                <span class="text-gray-500 text-lg">No Data Available</span>
              </div>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª -->
    <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
  <p-paginator 
    [rows]="5" 
    [totalRecords]="filteredVendors().length || 0"
   >
  </p-paginator>
</div>


  </div>
</p-dialog>

<!-- Dialog Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯ -->
<p-dialog header="{{isEditVendor ? 'Edit Vendor' : 'Add Vendor'}}"
          [(visible)]="vendorFormDialog" [modal]="true" [style]="{width:'40vw'}"
          [resizable]="true" [breakpoints]="{'960px':'90vw'}">

  <div class="flex flex-col h-full">

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙˆØ±Ù… -->
    <div class="flex-1 overflow-auto">
      <label class="block mb-1 font-semibold">Vendor Name</label>
      <input type="text" pInputText [(ngModel)]="currentVendor.name" class="w-full mb-2">

      <label class="block mb-1 font-semibold">Account No</label>
      <input type="text" pInputText [(ngModel)]="currentVendor.account" class="w-full mb-2">
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª -->
    <div class="flex-shrink-0 mt-2 flex justify-end gap-2">
      <button pButton label="Cancel" class="p-button-secondary" (click)="cancelVendor()"></button>
      <button pButton label="Save" class="p-button-success" (click)="saveVendor()"></button>
    </div>

  </div>
</p-dialog>


<p-confirmDialog></p-confirmDialog>
</div>
  `,
})
export class JournalEntriesComponent {

  journalEntries: any[] = [];
  displayDialog = false;
  isEdit = false;


  currentJournal: any = {
    entries: [
      { account: '', debit: null, credit: null, description: '', costCenter: '', currency: 'SAR' }
    ],
    totalDebit: 0,
    totalCredit: 0
  };


  accounts = [
    { name: 'vendor', code: '10101' },
    { name: 'Bank', code: '10102' },
    { name: 'Sales', code: '40101' },
    { name: 'Purchases', code: '50101' },
    { name: 'rjh', code: '10120' },
    { name: 'enma', code: '10130' },
    { name: 'belad', code: '40140' },
    { name: 'riadh', code: '50120' },
    { name: 'Cash', code: '60101' }
  ];

  costCenters = [
    { name: 'Main', code: '1001' },
    { name: 'Branch1', code: '1002' },
    { name: 'Branch2', code: '1003' },
    { name: 'Branch1', code: '1002' },
    { name: 'Branch2', code: '1003' },
    { name: 'Branch1', code: '1002' },
    { name: 'Branch2', code: '1003' },
    { name: 'ProjectX', code: '2001' }
  ];

  tags = [{ name: 'Urgent' }, { name: 'Internal' }, { name: 'External' }, { name: 'Follow-up' }];

  vendors = [
    { id: 1, name: 'Vendor A', account: '20101' },
    { id: 2, name: 'Vendor A', account: '20102' },
    { id: 3, name: 'Vendor A', account: '20103' },
    { id: 4, name: 'Vendor A', account: '20104' },
    { id: 5, name: 'Vendor A', account: '20105' },
    { id: 6, name: 'Vendor A', account: '20106' },
    { id: 7, name: 'Vendor A', account: '20107' },
    { id: 8, name: 'Vendor B', account: '20108' }
  ];

  accountDialog = false;
  costCenterDialog = false;
  vendorDialog = false;
  accountFilter = '';
  costCenterFilter = '';
  vendorFilter = '';
  editingRowIndex = 0;
  editingField: 'account' | 'costCenter' | 'vendor' = 'account';

  selectedRowIndex = -1;
  selectedLine: any = null;
  copiedLine: any = null;

  undoStack: any[] = [];
  redoStack: any[] = [];

  vendorFormDialog = false;
  isEditVendor = false;
  currentVendor: any = { id: 0, name: '', account: '' };

  journalIdFilter: string = '';

  contextMenuItems = [
    { label: 'Copy Line', icon: 'pi pi-copy', command: () => this.copyLine() },
    { label: 'Paste Line', icon: 'pi pi-clone', command: () => this.pasteLine() },
    { label: 'Delete Line', icon: 'pi pi-trash', command: () => this.removeJournalLine(this.selectedRowIndex) }
  ];
  constructor(private messageService: MessageService, private confirmationService: ConfirmationService) {
    this.journalEntries = [
      {
        id: 1,
        date: new Date().toISOString().substring(0, 10),
        entries: [{ account: 'Cash', description: 'Opening', debit: 1000, credit: 0, costCenter: 'Main', tags: ['Internal'] }],
        totalDebit: 1000,
        totalCredit: 0
      }
    ];
  }


  addNewLine(index: number) {
    if (!this.currentJournal.entries) {
      this.currentJournal.entries = [];
    }

    const newLine = {
      account: '',
      accountCode: '',
      vendor: '',
      vendorAccount: '',
      description: '',
      debit: 0,
      credit: 0,
      costCenter: '',
      costCenterCode: '',
      tags: [],
      isVendorEnabled: false
    };

    if (index === -1) {
      this.currentJournal.entries.push(newLine);
    } else {
      this.currentJournal.entries.splice(index + 1, 0, newLine);
    }
  }




  isBalanced(): boolean {
    return this.currentJournal.totalDebit === this.currentJournal.totalCredit;
  }

  // Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø¯Ø§Ø¦Ù†ØŒ ÙŠØ­Ø¯Ø« Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  updateTotals() {
    if (!this.currentJournal || !this.currentJournal.entries) return;

    let totalDebit = 0;
    let totalCredit = 0;

    for (let line of this.currentJournal.entries) {
      totalDebit += parseFloat(line.debit) || 0;
      totalCredit += parseFloat(line.credit) || 0;
    }

    this.currentJournal.totalDebit = totalDebit;
    this.currentJournal.totalCredit = totalCredit;
  }


  // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù
  openNewJournal() {
    this.isEdit = false;
    this.currentJournal = {
      id: 'JE-' + new Date().getTime(), // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ
      date: new Date().toISOString().substring(0, 10),
      status: 'Pending',               // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      type: 'Daily',                   // Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      entries: [
        { account: '', accountCode: '', vendor: '', vendorAccount: '', description: '', debit: 0, credit: 0, costCenter: '', costCenterCode: '', tags: [] }
      ],
      totalDebit: 0,
      totalCredit: 0,
      notes: ''
    };
    this.displayDialog = true;
  }


  editJournal(journal: any) {
    this.isEdit = true;
    this.currentJournal = JSON.parse(JSON.stringify(journal));
    this.displayDialog = true;
  }

  addJournalLine() {
    this.currentJournal.entries.push({ account: '', accountCode: '', vendor: '', vendorAccount: '', description: '', debit: 0, credit: 0, costCenter: '', costCenterCode: '', tags: [] });
    this.pushUndo();
  }

  removeJournalLine(index: number) {
    if (index >= 0) {
      this.currentJournal.entries.splice(index, 1);
      this.calculateCurrentTotals();
      this.pushUndo();
    }
  }

  calculateTagTotal(tagName: string) {
    return this.currentJournal.entries.filter((l: any) => l.tags?.includes(tagName))
      .reduce((sum: any, l: any) => sum + (Number(l.debit || 0) + Number(l.credit || 0)), 0);
  }


  saveJournal() {
    let valid = true;

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø³Ø·Ø±
    this.currentJournal.entries.forEach((line: any) => {
      // Ø§Ù„Ø­Ø³Ø§Ø¨
      const acc = this.accounts.find(a => a.code === line.accountCode || a.name === line.account);
      line.invalidAccount = !acc;
      if (!acc) valid = false;


      // Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©
      const cc = this.costCenters.find(c => c.code === line.costCenterCode || c.name === line.costCenter);
      line.invalidCostCenter = !cc;
      if (!cc) valid = false;
    });

    // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù†
    this.calculateCurrentTotals();
    if (this.currentJournal.totalDebit !== this.currentJournal.totalCredit) {
      this.messageService.clear();
      this.messageService.add({ severity: 'error', summary: 'Error', detail: 'Total debit does not equal total credit' });
      valid = false;
    }

    if (!valid) {
      this.messageService.clear();
      this.messageService.add({ severity: 'warn', summary: 'Validation', detail: 'Please correct highlighted fields before saving' });
      return; // Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸
    }

    // Ø¥Ø°Ø§ ÙƒÙ„ Ø´ÙŠØ¡ ØµØ­ÙŠØ­
    if (this.isEdit) {
      const index = this.journalEntries.findIndex(j => j.id === this.currentJournal.id);
      if (index > -1) this.journalEntries[index] = JSON.parse(JSON.stringify(this.currentJournal));
    } else {
      this.journalEntries.push(JSON.parse(JSON.stringify(this.currentJournal)));
    }

    this.displayDialog = false;
    this.messageService.clear();
    this.messageService.add({ severity: 'success', summary: 'Saved', detail: 'Entry saved successfully' });
  }

  deleteJournal(index: number) {
    this.confirmationService.confirm({
      message: 'Do you want to delete this entry?',
      header: 'Confirm Delete',
      icon: 'pi pi-exclamation-triangle',
      accept: () => {
        this.journalEntries.splice(index, 1);
        this.messageService.clear();
        this.messageService.add({ severity: 'success', summary: 'Deleted', detail: 'Entry deleted successfully' });
      }
    });
  }


  formatWithCommas(line: any, field: 'debit' | 'credit') {
    let val = line[field]?.toString().replace(/,/g, '');
    if (!val) return;

    const numericVal = Number(val);
    if (!isNaN(numericVal)) {
      line[field] = numericVal;
    }

    if (field === 'debit' && line.debit) line.credit = null;
    if (field === 'credit' && line.credit) line.debit = null;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    this.currentJournal.totalDebit = this.currentJournal.entries.reduce(
      (sum: number, entry: any) => sum + (entry.debit || 0), 0
    );
    this.currentJournal.totalCredit = this.currentJournal.entries.reduce(
      (sum: number, entry: any) => sum + (entry.credit || 0), 0
    );

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„Ø¥Ø®Ø¨Ø§Ø± Angular Ø¨Ø§Ù„ØªØºÙŠÙŠØ±
    this.currentJournal.entries = this.currentJournal.entries.slice();
  }


  calculateCurrentTotals() {
    this.currentJournal.totalDebit = this.currentJournal.entries.reduce((sum: any, line: any) => {
      const val = parseFloat((line.debit || '0').toString().replace(/,/g, ''));
      return sum + (isNaN(val) ? 0 : val);
    }, 0);

    this.currentJournal.totalCredit = this.currentJournal.entries.reduce((sum: any, line: any) => {
      const val = parseFloat((line.credit || '0').toString().replace(/,/g, ''));
      return sum + (isNaN(val) ? 0 : val);
    }, 0);
  }



  // Ù„Ù„Ù€ F9 ÙƒÙ…Ø§ ÙƒØ§Ù†
  openAccountSearch(event: any, rowIndex: number) {
    this.editingRowIndex = rowIndex;
    if (event.key === 'F9') {
      this.accountDialog = true;
    }
  }

  // Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
  handleAccountInput(event: any, rowIndex: number) {
    const inputValue = event.target.value.trim();
    const found = this.accounts.find(a => a.code === inputValue || a.name === inputValue);
    const line = this.currentJournal.entries[rowIndex];

    if (found) {
      line.account = found.name;
      line.accountCode = found.code;
      line.invalidAccount = false;

      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
      if (found.name.toLowerCase().includes('vendor') || found.code.startsWith('201')) {
        line.isVendorEnabled = true;
      } else {
        line.isVendorEnabled = false;
        line.vendor = '';           // Ù…Ø³Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù†Ø¯ ØªØ¹Ø·ÙŠÙ„Ù‡
        line.vendorAccount = '';
      }

    } else {
      line.invalidAccount = inputValue !== '';
      line.isVendorEnabled = false;
      line.vendor = '';
      line.vendorAccount = '';
    }
  }



  openCostCenterSearch(event: any, rowIndex: number) {
    this.editingRowIndex = rowIndex;
    if (event.key === 'F9') { this.costCenterDialog = true; }
  }

  handleCostCenterInput(event: any, rowIndex: number) {
    const inputValue = event.target.value.trim();
    const found = this.costCenters.find(c => c.code === inputValue || c.name === inputValue);

    const line = this.currentJournal.entries[rowIndex];
    if (found) {
      line.costCenter = found.name;
      line.costCenterCode = found.code;
      line.invalidCostCenter = false;
    } else {
      line.invalidCostCenter = inputValue !== '';
    }
  }


  openVendorDialog(event: any, rowIndex: number) {
    this.editingRowIndex = rowIndex;
    if (event.key === 'F9') { this.vendorDialog = true; }
  }

  handleVendorInput(event: any, rowIndex: number) {
    const inputValue = event.target.value.trim();
    const found = this.vendors.find(v => v.account === inputValue || v.name === inputValue);

    const line = this.currentJournal.entries[rowIndex];
    if (found) {
      line.vendor = found.name;
      line.vendorAccount = found.account;
      line.invalidVendor = false;
    } else {
      line.invalidVendor = inputValue !== '';
    }
  }


  filteredJournals(filterText: string) {
    if (!this.journalEntries) return [];

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ„ØªØ± Ù„Ø£ÙŠ Ù†ÙˆØ¹ Ø¥Ù„Ù‰ Ù†Øµ ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
    const filter = filterText != null ? filterText.toString().trim().toLowerCase() : '';

    if (!filter) return this.journalEntries;

    return this.journalEntries.filter(j => {
      // Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ù„Ù‰ Ù†Øµ Ù„Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±
      const id = j.id?.toString().toLowerCase() || '';
      const date = j.date?.toString().toLowerCase() || '';
      const totalDebit = j.totalDebit?.toString().toLowerCase() || '';
      const totalCredit = j.totalCredit?.toString().toLowerCase() || '';

      // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      return id.includes(filter) || date.includes(filter) || totalDebit.includes(filter) || totalCredit.includes(filter);
    });
  }
  // ğŸŸ¢ Ø§Ù„ÙÙ„Ø§ØªØ±
  filteredAccounts() {
    const filter = this.accountFilter.trim();
    if (!filter) return this.accounts;
    return this.accounts.filter(a =>
      a.name.toLowerCase().includes(filter.toLowerCase()) ||
      a.code.includes(filter)
    );
  }

  selectAccount(acc: any) {
    if (this.selectedRowIndex >= 0) {
      const line = this.currentJournal.entries[this.selectedRowIndex];
      line.account = acc.name;
      line.accountCode = acc.code;

      // ğŸ”¹ Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ù‘Ø¯ØŒ ÙØ¹Ù‘Ù„ Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯
      line.isVendorEnabled = acc.name.toLowerCase().includes('vendor') || acc.code.startsWith('10101');

      this.accountDialog = false;
    }
  }



  filteredCostCenters() {
    const filter = this.costCenterFilter.trim();
    if (!filter) return this.costCenters;
    return this.costCenters.filter(c =>
      c.name.toLowerCase().includes(filter.toLowerCase()) ||
      c.code.includes(filter)
    );
  }

  selectCostCenter(cc: any) {
    const line = this.currentJournal.entries[this.editingRowIndex];
    line.costCenter = cc.name;
    line.costCenterCode = cc.code;
    this.costCenterDialog = false;
    line.invalidAccount = false;
    this.costCenterFilter = '';
  }

  filteredVendors() {
    const filter = this.vendorFilter.trim();
    if (!filter) return this.vendors;
    return this.vendors.filter(v =>
      v.name.toLowerCase().includes(filter.toLowerCase()) ||
      v.account.includes(filter)
    );
  }

  selectVendor(vn: any) {
    const line = this.currentJournal.entries[this.editingRowIndex];
    line.vendor = vn.name;
    line.vendorAccount = vn.account;
    this.vendorDialog = false;
    line.invalidAccount = false;
    this.vendorFilter = '';
  }

  // ğŸŸ¢ Vendor form
  openAddVendor() {
    this.isEditVendor = false;
    this.currentVendor = { id: this.vendors.length + 1, name: '', account: '' };
    this.vendorFormDialog = true;
  }

  openEditVendor(vendor: any) {
    this.isEditVendor = true;
    this.currentVendor = JSON.parse(JSON.stringify(vendor));
    this.vendorFormDialog = true;
  }

  saveVendor() {
    if (this.isEditVendor) {
      const index = this.vendors.findIndex(v => v.id === this.currentVendor.id);
      if (index > -1) this.vendors[index] = JSON.parse(JSON.stringify(this.currentVendor));
    } else {
      this.vendors.push(JSON.parse(JSON.stringify(this.currentVendor)));
    }
    this.vendorFormDialog = false;
  }

  cancelVendor() {
    this.vendorFormDialog = false;
  }



  // ğŸŸ¢ Ù†Ø³Ø® / Ù„ØµÙ‚
  copyLine() {
    if (this.selectedRowIndex >= 0) {
      this.copiedLine = { ...this.currentJournal.entries[this.selectedRowIndex] };
      this.messageService.clear(); this.messageService.add({ severity: 'info', summary: 'Copied', detail: 'Line copied' });
    }
  }
  pasteLine() {
    if (this.copiedLine) {
      this.currentJournal.entries.splice(this.selectedRowIndex + 1, 0, { ...this.copiedLine });
      this.messageService.clear(); this.messageService.add({ severity: 'success', summary: 'Pasted', detail: 'Line pasted' });
      this.calculateCurrentTotals(); this.pushUndo();
    }
  }

  // ğŸŸ¢ Undo / Redo
  pushUndo() { this.undoStack.push(JSON.stringify(this.currentJournal.entries)); if (this.undoStack.length > 50) this.undoStack.shift(); }
  undo() { if (this.undoStack.length > 0) { this.redoStack.push(JSON.stringify(this.currentJournal.entries)); this.currentJournal.entries = JSON.parse(this.undoStack.pop()!); this.calculateCurrentTotals(); } }
  redo() { if (this.redoStack.length > 0) { this.undoStack.push(JSON.stringify(this.currentJournal.entries)); this.currentJournal.entries = JSON.parse(this.redoStack.pop()!); this.calculateCurrentTotals(); } }


  @HostListener('document:keydown', ['$event'])
  handleKeyboard(event: KeyboardEvent) {
    const key = event.key ? event.key.toLowerCase() : '';

    if (event.ctrlKey) {
      switch (key) {
        case 'c': case 'Ø¤': this.copyLine(); event.preventDefault(); break;
        case 'v': case 'Ø±': this.pasteLine(); event.preventDefault(); break;
        case 'x': case 'Ø¡': this.copyLine(); this.removeJournalLine(this.selectedRowIndex); event.preventDefault(); break;
        case 'z': case 'Ø¦': this.undo(); event.preventDefault(); break;
        case 'y': case 'Øº': this.redo(); event.preventDefault(); break;
      }
    } else if (key === 'delete' && this.selectedRowIndex >= 0) { this.removeJournalLine(this.selectedRowIndex); event.preventDefault(); }
  }



  // ğŸŸ¢ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  printEntry(journal: any) {
    const lines = journal.entries.map((line: any) => `
        <tr>
          <td>${line.account}</td>
          <td>${line.description}</td>
          <td>${line.debit}</td>
          <td>${line.credit}</td>
          <td>${line.costCenter}</td>
          <td>${line.tags?.join(', ')}</td>
        </tr>
      `).join('');
    const html = `
        <html>
        <head>
          <title>Entry #${journal.id}</title>
          <style>
            body {font-family: Arial, sans-serif;}
            h2 {text-align:center;}
            table {width:100%; border-collapse: collapse; margin-bottom:10px;}
            th, td {border: 1px solid #000; padding: 5px; text-align: left;}
            th {background: #eee;}
            .footer {margin-top:20px; display:flex; justify-content:space-between;}
          </style>
        </head>
        <body>
          <h2>Company Name</h2>
          <h3>Journal Entry #${journal.id} - ${journal.date}</h3>
          <table>
            <tr>
              <th>Account</th><th>Description</th><th>Debit</th><th>Credit</th><th>Cost Center</th><th>Tags</th>
            </tr>
            ${lines}
            <tr>
              <td colspan="2" style="text-align:right"><strong>Total:</strong></td>
              <td>${journal.totalDebit}</td>
              <td>${journal.totalCredit}</td>
              <td></td>
              <td></td>
            </tr>
          </table>
          <div class="footer">
            <span>Prepared By: __________</span>
            <span>Approved By: __________</span>
          </div>
        </body>
        </html>
      `;
    const newWindow = window.open('', '_blank');
    newWindow?.document.write(html);
    newWindow?.document.close();
    newWindow?.print();
  }
}








   /*  <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5">
                    <div class="flex flex-col items-center justify-center h-full py-10">
                        <i class="pi pi-database" style="font-size: 2rem"></i>
                        <span class="text-gray-500 text-lg text-center">
                            {{ filteredJournals(journalIdFilter).length ? 'No results found for your search' : 'No Data
                            Available' }}
                        </span>
                    </div>
                </td>
            </tr>
        </ng-template>






.card {
  min-height: 60vh;
  position: relative;
      }











  <div class="page-loader" *ngIf="loading" style="
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 20;
  ">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"  class="loader-img" alt="Loading">
        <!-- Ø§Ù„ØµØ¯ÙØ© -->
        <path
            d="M32 6C20 6 8 16 8 28c0 10 10 18 24 18s24-8 24-18C56 16 44 6 32 6z"
            fill="var(--primary-color)"
            opacity="0.8"
        />
        <!-- Ø§Ù„Ù„Ø¤Ù„Ø¤Ø© -->
        <circle cx="32" cy="32" r="8" fill="white" stroke="var(--primary-color)" stroke-width="2" />
        <!-- Ù„Ù…Ø¹Ø© -->
        <circle cx="30" cy="30" r="3" fill="rgba(255,255,255,0.7)" />
    </svg>
    <span style="font-weight:700; font-size:1.4rem; color:var(--primary-color); margin-right:0.5rem;">
        Ø§Ù„Ù€Ù€Ø¯ÙÙ‘Ø±Ù‘
    </span>
  </div>















  
  <!-- ====== Dialog Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© ====== -->
  <p-dialog header="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©" [(visible)]="displayDialog" [modal]="true" [closable]="true"
    [style]="{width:'400px'}">
    <div *ngIf="selectedTransaction">
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</strong> {{selectedTransaction.accountNumber}}</p>
      <p><strong>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</strong> {{selectedTransaction.accountName}}</p>
      <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{selectedTransaction.date | date:'yyyy-MM-dd'}}</p>
      <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©:</strong> {{selectedTransaction.type}}</p>
      <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{selectedTransaction.amount | number:'1.2-2'}}</p>
      <p><strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ:</strong> {{selectedTransaction.balance | number:'1.2-2'}}</p>
      <p><strong>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©:</strong> {{selectedTransaction.costCenter}}</p>
      <p><strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> {{selectedTransaction.project}}</p>
      <p><strong>Ø§Ù„ÙˆØµÙ:</strong> {{selectedTransaction.description}}</p>
      <p><strong>Ø§Ù„Ø¹Ù…Ù„Ø©:</strong> {{selectedTransaction.currency}}</p>
    </div>
  </p-dialog>

  <!-- ====== Dialog Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙŠØ§Ù† Ø¹Ù†Ø¯ F9 ====== -->
  <p-dialog header="Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ " [(visible)]="displayAccountDialog" [modal]="true"
    [style]="{'width':'50vw','height':'450px'}" [resizable]="false" [breakpoints]="{'960px':'90vw'}">

    <div class="flex flex-col h-full">

      <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
      <div class="flex gap-2 mb-2 flex-shrink-0">
        <input type="text" pInputText [(ngModel)]="accountFilter" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙŠØ§Ù†..." class="flex-1"
          (input)="updateFilteredAccounts()">
      </div>

      <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ scrollable -->
      <div class="flex-1 overflow-auto min-h-[250px]">
        <p-table [value]="filteredParentAccounts" [scrollable]="true" scrollHeight="100%">
          <ng-template pTemplate="header">
            <tr>
              <th>#</th>
              <th>Account ID</th>
              <th>Account Name</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-acc let-i="rowIndex">
            <tr style="height:50px" (click)="selectParentAccount(acc)"
              class="cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700"
              [ngClass]="{'bg-blue-100 dark:bg-blue-700': selectedParentAccount?.id === acc.id}">
              <td>{{i + 1}}</td>
              <td>{{acc.code}}</td>
              <td>{{acc.name}}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="3">
                <div class="flex flex-col items-center justify-center h-full py-10">
                  <i class="pi pi-database text-2xl mb-2"></i>
                  <span class="text-gray-500 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª Ù…Ø¹ paginator -->
      <div class="flex-shrink-0 mt-2 border-t pt-2 
                bg-white border-gray-200 
                dark:bg-[#18181b] dark:border-gray-700">
        <p-paginator [rows]="5" [totalRecords]="filteredParentAccounts.length || 0"></p-paginator>
      </div>

    </div>
  </p-dialog>




  <!-- Dialog Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© -->

  <p-dialog header="Select Cost Center" [(visible)]="costCenterDialog" [modal]="true"
    [style]="{'width':'50vw','height':'450px'}" [resizable]="false" [breakpoints]="{'960px':'90vw'}">

    <div class="flex flex-col h-full">

      <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª -->
      <div class="mb-2 flex-shrink-0">
        <input type="text" pInputText [(ngModel)]="costCenterFilter" placeholder="Search cost center..." class="w-full"
          (input)="filteredCostCenters()">
      </div>

      <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ scrollable -->
      <div class="flex-1 overflow-auto min-h-[250px]">
        <p-table [value]="filteredCostCentersList" [scrollable]="true" scrollHeight="100%">
          <ng-template pTemplate="header">
            <tr>
              <th>#</th>
              <th>Cost Center Name</th>
              <th>Cost Center No</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-cc let-i="rowIndex">
            <tr style="height:50px" (click)="selectCostCenter(cc)" class="cursor-pointer hover:bg-gray-200">
              <td>{{i + 1}}</td>
              <td>{{cc.name}}</td>
              <td>{{cc.code}}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="3">
                <div class="flex flex-col items-center justify-center h-full py-10">
                  <i class="pi pi-database" style="font-size: 2rem"></i>
                  <span class="text-gray-500 text-lg">No Data Available</span>
                </div>
              </td>
            </tr>
          </ng-template>

        </p-table>
      </div>

      <!-- Ø§Ù„ÙÙˆØªØ± Ø«Ø§Ø¨Øª -->
      <div class="flex-shrink-0 mt-2 border-t pt-2 
            bg-white border-gray-200 
            dark:bg-[#18181b] dark:border-gray-700">
        <p-paginator [rows]="5" [totalRecords]="filteredCostCentersList.length || 0">
        </p-paginator>
      </div>

    </div>
  </p-dialog>



</div>

menu
@use 'mixins' as *;

.layout-sidebar {
  position: fixed;
  width: 20rem;
  height: calc(100vh - 8rem);
  z-index: 999;
  overflow-y: auto;
  user-select: none;
  top: 6rem;
  background-color: var(--surface-overlay);
  border-radius: var(--content-border-radius);
  padding: 0.5rem 1.5rem;
 transition: transform 0.3s ease;

}


/* ========================= */
/* âœ… LRT Sidebar Fix */
/* ========================= */
html[dir="ltr"] .layout-sidebar {

left: 2rem;
right: auto;

    transition:
        transform var(--layout-section-transition-duration),
        left var(--layout-section-transition-duration);
}


/* ========================= */
/* âœ… RTL Sidebar  */
/* ========================= */
html[dir="rtl"] .layout-sidebar {
      right: 2rem;
       left: auto;
      
       transition:
       transform var(--layout-section-transition-duration),
        right var(--layout-section-transition-duration);
   .layout-menu {
        a {
            .layout-menuitem-icon {
                margin-left: 0.5rem;
                margin-right: 0;
            }
             .layout-submenu-toggler {
                margin-right: auto;
                margin-left: 0;
                
              
            }
        }
         ul {
              overflow: hidden;
              border-radius: var(--content-border-radius);

              li {
                a { margin-right: 1rem; }

                li { a { margin-right: 2rem; } }
                li li { a { margin-right: 2.5rem; } }
                li li li { a { margin-right: 3rem; } }
                li li li li { a { margin-right: 3.5rem; } }
                li li li li li { a { margin-right: 4rem; } }
              }

            }
}
}
   

.layout-menu {
    margin: 0;
    padding: 0;
    list-style-type: none;

    .layout-root-menuitem {
        > .layout-menuitem-root-text {
            font-size: 0.857rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-color);
            margin: 0.75rem 0;
        }

        > a {
            display: none;
        }
    }

    a {
        user-select: none;

        &.active-menuitem {
            > .layout-submenu-toggler {
                transform: rotate(-180deg);
            }
        }
    }

    li.active-menuitem {
        > a {
            .layout-submenu-toggler {
                transform: rotate(-180deg);
            }
        }
    }

    ul {
        margin: 0;
        padding: 0;
        list-style-type: none;

        a {
            display: flex;
            align-items: center;
            position: relative;
            outline: 0 none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: var(--content-border-radius);
            transition:
                background-color var(--element-transition-duration),
                box-shadow var(--element-transition-duration);

            .layout-menuitem-icon {
                margin-right: 0.5rem;
            }

            .layout-submenu-toggler {
                font-size: 75%;
                margin-left: auto;
                transition: transform var(--element-transition-duration);
            }

            &.active-route {
                font-weight: 700;
                color: var(--primary-color);
            }

            &:hover {
                background-color: var(--surface-hover);
            }

            &:focus {
                @include focused-inset();
            }
        }

        ul {
            overflow: hidden;
            border-radius: var(--content-border-radius);

            li {
                a { margin-left: 1rem; }

                li { a { margin-left: 2rem; } }
                li li { a { margin-left: 2.5rem; } }
                li li li { a { margin-left: 3rem; } }
                li li li li { a { margin-left: 3.5rem; } }
                li li li li li { a { margin-left: 4rem; } }
            }
        }
    }
}

.layout-submenu-enter-from,
.layout-submenu-leave-to {
    max-height: 0;
}

.layout-submenu-enter-to,
.layout-submenu-leave-from {
    max-height: 1000px;
}

.layout-submenu-leave-active {
    overflow: hidden;
    transition: max-height 0.45s cubic-bezier(0, 1, 0, 1);
}

.layout-submenu-enter-active {
    overflow: hidden;
    transition: max-height 1s ease-in-out;
}



/* ========================= */
/* âœ… RTL Sidebar Mobile Fix */
/* ========================= */
@media (max-width: 1024px) {
  html[dir="rtl"] {
    .layout-sidebar {
    right: 0;
    left: auto;
    transform: translateX(100%); /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    }

    /* Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø© */
    .layout-sidebar.active {
      transform: translateX(0); /* ØªØ¸Ù‡Ø± */
    }
  }

  html[dir="ltr"] {
    .layout-sidebar {
      left: 0;          /* Ø¸Ù‡ÙˆØ± Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
      right: auto;
      transform: translateX(-100%);/* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
    }

    .layout-sidebar.active {
      transform: translateX(0);
    }
  }
}







responsiveLayout



@media screen and (min-width: 1960px) {
    .layout-main,
    .landing-wrapper {
        width: 1504px;
        margin-left: auto !important;
        margin-right: auto !important;
    }
}

@media (min-width: 992px) {
    .layout-wrapper {
        &.layout-overlay {
            .layout-main-container {
                margin-left: 0;
                margin-right: 0;
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .layout-sidebar {
                transform: translateX(-100%);
                left: 0;
                right: auto;
                top: 0;
                height: 100vh;
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
                border-right: 1px solid var(--surface-border);
                transition:
                    transform 0.4s cubic-bezier(0.05, 0.74, 0.2, 0.99),
                    left 0.4s cubic-bezier(0.05, 0.74, 0.2, 0.99);
                box-shadow:
                    0px 3px 5px rgba(0, 0, 0, 0.02),
                    0px 0px 2px rgba(0, 0, 0, 0.05),
                    0px 1px 4px rgba(0, 0, 0, 0.08);
            }

            &.layout-overlay-active {
                .layout-sidebar {
                    transform: translateX(0);
                }
            }
        }

        &.layout-static {
            .layout-main-container {
                margin-left: 22rem;
                margin-right: 0;
            }

            &.layout-static-inactive {
                .layout-sidebar {
                    transform: translateX(-100%);
                    left: 0;
                    right: auto;
                }

                .layout-main-container {
                    margin-left: 0;
                    margin-right: 0;
                    padding-left: 2rem;
                    padding-right: 2rem;
                }
            }
        }

        .layout-mask {
            display: none;
        }
    }
}

@media (max-width: 991px) {
    .blocked-scroll {
        overflow: hidden;
    }

    .layout-wrapper {
        .layout-main-container {
            margin-left: 0;
            margin-right: 0;
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .layout-sidebar {
            transform: translateX(-100%);
            left: 0;
            right: auto;
            top: 0;
            height: 100vh;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            transition:
                transform 0.4s cubic-bezier(0.05, 0.74, 0.2, 0.99),
                left 0.4s cubic-bezier(0.05, 0.74, 0.2, 0.99);
        }

        .layout-mask {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 998;
            width: 100%;
            height: 100%;
            background-color: var(--maskbg);
        }

        &.layout-mobile-active {
            .layout-sidebar {
                transform: translateX(0);
            }

            .layout-mask {
                display: block;
            }
        }
    }
}


/* âœ… RTL Adjustments Fixed */
/* ========================= */
html[dir="rtl"] 
{

  .layout-static .layout-main-container {
    margin-left: 0;
    margin-right: 22rem; // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦Ø³ÙŠÙ‰ Ùˆ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§ÙÙ‡ Ø¨ÙŠÙ†Ù‡Ù…Ø§ sidebar Ø¹Ù„Ù‰ Desktop
  }

  .layout-static-inactive .layout-main-container,
  .layout-overlay .layout-main-container {
    margin-left: 0;
    margin-right: 0;
  }

  .layout-overlay .layout-sidebar,
  .layout-static-inactive .layout-sidebar {
    left: auto;
    right: 0;
    transform: translateX(100%); // Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ ÙÙŠ Mobile
    transition: transform 0.3s ease;
  }

  .layout-overlay .layout-sidebar.active,
  .layout-static-inactive .layout-sidebar.active {
    transform: translateX(0); // ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
  }

  /* Mobile adjustments */
  @media (max-width: 991px) {
    .layout-wrapper .layout-main-container {
      margin-left: 0;
      margin-right: 0;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .layout-overlay .layout-sidebar,
    .layout-static-inactive .layout-sidebar {
      width: 80%; // ÙŠÙ…ÙƒÙ† Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Mobile
      top: 0;
      height: 100%;
      border-radius: 0; // Ù„ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø©
    }
  }
}

