import { Component, OnInit, ViewChild, HostListener, CUSTOM_ELEMENTS_SCHEMA, ElementRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Table, TableModule } from 'primeng/table';
import { ButtonModule } from 'primeng/button';
import { InputTextModule } from 'primeng/inputtext';
import { ToastModule } from 'primeng/toast';
import { MessageService } from 'primeng/api';
import { RippleModule } from 'primeng/ripple';
import { SelectModule } from 'primeng/select';
import { DatePickerModule } from 'primeng/datepicker';
import { TooltipModule } from 'primeng/tooltip';
import { InputGroupModule } from 'primeng/inputgroup';
import { TagModule } from 'primeng/tag';
import { ChartModule } from 'primeng/chart';
import { DialogModule } from 'primeng/dialog';
import { AccordionModule } from 'primeng/accordion';
import { HttpErrorResponse } from '@angular/common/http';

import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import * as XLSX from 'xlsx';

import { EntitiesService, JournalEntryDto, JournalFilterDto } from '@/apiservice/Entities.service';
import { AccountsService } from '@/apiservice/accounts.service';

interface Account {
  id: number;
  type?: string;
  name: string;
  code?: string;
  parentId?: number;
  children?: Account[];
}

interface CostCenter {
  label: string;
  value: string;
  selected?: boolean;
}

interface Transaction {
  id: number;
  mainAccountId: number;        // الحساب الرئيسي
  subAccountId?: number;        // الحساب التحليلي
  contractorId?: number;        // الكيان
  accountNumber: string;        // رقم الحساب الرئيسي
  accountName: string;          // اسم الحساب التحليلي
  date: Date;
  type: 'مدين' | 'دائن';
  amount: number;
  balance: number;
  costCenterId?: number;
  costCenter?: string;
  project?: string;
  description?: string;
  currency?: string;
}


@Component({
  selector: 'app-financial-report',
  standalone: true,
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  imports: [
    CommonModule, FormsModule, TableModule, ButtonModule, InputTextModule,
    ToastModule, RippleModule, SelectModule, DatePickerModule, InputGroupModule,
    TagModule, TooltipModule, ChartModule, AccordionModule, DialogModule
  ],
  templateUrl: './financial-report.component.html',
  providers: [MessageService]
})
export class FinancialReportComponent implements OnInit {
  @ViewChild('dt') dt!: Table;
  @ViewChild('mainAccountInput') mainAccountInput!: ElementRef;
@ViewChild('subAccountInput') subAccountInput!: ElementRef;
@ViewChild('costFromInput') costFromInput!: ElementRef;
@ViewChild('costToInput') costToInput!: ElementRef;


selectedParentAccount?: Account;
selectedEntity?: { id: number, name: string };
selectedSubAccount?: Account;
selectedMainAccount?: Account;

  filteredAccountsList: Account[] = [];
  allParentAccounts: Account[] = []; // نسخة أصلية
  selectedCostCenterNameFrom: string | null = null;
  selectedCostCenterNameTo: string | null = null;
  // تعريف البيانات الخاصة بتقرير مراكز التكلفة
  costCenterReportData: {
    name: string;
    totalDebit: number;
    totalCredit: number;
    balance: number
  }[] = [];
  costCenters: CostCenter[] = [];

  // مركز التكلفة المحدد (واحد أو متعدد مستقبلاً)
  selectedCostCenter: Account | null = null;

  // الحركات الخاصة بمركز التكلفة
  journalEntries: JournalEntryDto[] = [];


  accounts: Account[] = [];

  accountFilter = '';
  filteredParentAccounts: Account[] = [];
  costCenterDialog = false;
  childCostCenters: Account[] = [];
  costCenterFilter: string = '';
  filteredCostCentersList: Account[] = [];
  childAccounts: Account[] = [];

  transactions: Transaction[] = [];
  filteredTransactions: Transaction[] = [];
  loading = false;

  financialYears = [{ label: '2023', value: 2023 }, { label: '2024', value: 2024 }, { label: '2025', value: 2025 }];
  transactionTypes = [{ label: 'مدين', value: 'مدين' }, { label: 'دائن', value: 'دائن' }];
  currencies = [{ label: 'SAR', value: 'SAR' }, { label: 'USD', value: 'USD' }];

  parentAccounts: Account[] = [];
  displayDialog = false;
  displayAccountDialog = false;
  selectedTransaction: Transaction | null = null;

  filterData = {
    mainAccountId: 0,
    startDate: null as Date | null,
    endDate: null as Date | null,
    accountNumber: '',
    accountName: '',
    mainAccount: '',
    financialYear: null as number | null,
    transactionType: null as 'مدين' | 'دائن' | null,
    costCenterFrom: null as string | null,
    costCenterTo: null as string | null,
    project: null as string | null,
    currency: null as string | null
  };


  clearFilters() {
  // إعادة تعيين بيانات الفلترة
  this.filterData = {
    mainAccountId: 0,
    startDate: null,
    endDate: null,
    accountNumber: '',
    accountName: '',
    mainAccount: '',
    financialYear: null,
    transactionType: null,
    costCenterFrom: null,
    costCenterTo: null,
    project: null,
    currency: null
  };

  // إلغاء تحديد مراكز التكلفة
  this.costCenters.forEach(c => c.selected = false);

  // مسح البيانات من الجدول
  this.transactions = [];
  this.filteredTransactions = [];

  // إعادة حساب المجاميع
  this.calculateTotals();
}



  totalDebit = 0;
  totalCredit = 0;
  finalBalance = 0;
  avgTransaction = 0;

  constructor(
    private messageService: MessageService,
    private accountsService: AccountsService,
    private entitiesService: EntitiesService
  ) { }

  ngOnInit() {
    this.loadCostCenters();
    this.loadParentAccounts();
    this.loadAccounts();



  }






  loadAccounts() {
    this.accountsService.getAccounts().subscribe({
      next: (res: Account[]) => {
        this.accounts = res;               // بيانات الشجرة
        this.filteredAccountsList = this.getAllChildAccounts(res); // استخراج كل الحسابات الفرعية
      },
      error: (err) => console.error('Error loading accounts', err)
    });
  }


  // استخراج كل الحسابات الفرعية مع تجاهل مراكز التكلفة
  getAllChildAccounts(accounts: Account[]): Account[] {
    let children: Account[] = [];

    accounts.forEach(acc => {
      if (acc.type === 'Cost_Centers') return; // تجاهل مراكز التكلفة

      if (acc.children && acc.children.length > 0) {
        // إضافة الأبناء مباشرة إذا ليس مركز تكلفة
        children.push(...acc.children.filter(c => c.type !== 'Cost_Centers'));
        // استدعاء إعادة للطريقة للأبناء
        children.push(...this.getAllChildAccounts(acc.children));
      }
    });

    return children;
  }

loadParentAccounts(openDialog: boolean = false) {
  this.entitiesService.getAllEntities().subscribe({
    next: (res) => {
      this.parentAccounts = res;
      this.allParentAccounts = [...res];
      this.filteredParentAccounts = [...this.parentAccounts];

      if (openDialog) {
        this.parentAccounts.forEach(parent => {
          parent.children = this.getLeafAccounts(parent.children || []);
        });
        this.displayAccountDialog = true;
      }
    },
    error: (err) => {
      console.error('Failed to load parent accounts', err);
    }
  });
}


// دالة مساعدة للحصول على الحسابات الأبناء النهائيين
getLeafAccounts(accounts: Account[]): Account[] {
  return accounts.reduce((leaves: Account[], acc) => {
    if (!acc.children || acc.children.length === 0) {
      leaves.push(acc);
    } else {
      leaves.push(...this.getLeafAccounts(acc.children));
    }
    return leaves;
  }, []);
}


  flattenChildAccounts(accounts: Account[]): Account[] {
    let result: Account[] = [];

    accounts.forEach(acc => {
      if (acc.type === 'Cost_Centers') return; // تجاهل مراكز التكلفة

      if (acc.children && acc.children.length > 0) {
        result = result.concat(this.flattenChildAccounts(acc.children));
      }

      if (acc.parentId != null) { // الحسابات الأبناء فقط
        result.push(acc);
      }
    });

    return result;
  }
filterAccountsRecursive(accounts: Account[], term: string): Account[] {
  const lowerTerm = term.toLowerCase();
  return accounts
    .map(acc => {
      let matchChildren: Account[] = [];
      if (acc.children && acc.children.length) {
        matchChildren = this.filterAccountsRecursive(acc.children, term);
      }
      const matchesSelf = acc.name.toLowerCase().includes(lowerTerm) || acc.id.toString().includes(lowerTerm);
      if (matchesSelf || matchChildren.length) {
        return { ...acc, children: matchChildren };
      }
      return null;
    })
    .filter(acc => acc !== null) as Account[];
}

updateFilteredAccounts() {
  const filter = this.accountFilter.trim().toLowerCase();

  let accountsToFilter: Account[] = [];

  if (this.currentFocus === 'subAccount') {
    // الحسابات الرئيسية فقط
    accountsToFilter = this.allParentAccounts.filter(acc => !acc.parentId);
  } else if (this.currentFocus === 'mainAccount') {
    // الحسابات الفرعية فقط
    accountsToFilter = this.flattenChildAccounts(this.accounts);
  }

  if (!filter) {
    this.filteredParentAccounts = [...accountsToFilter];
  } else {
    const filtered = accountsToFilter.filter(acc =>
      acc.name.toLowerCase().includes(filter) || acc.id.toString().includes(filter)
    );

    this.filteredParentAccounts = filtered.length ? filtered : [...accountsToFilter];
  }
}



 loadCostCenters() {
  this.accountsService.getAllCostCenters().subscribe({
    next: (res: Account[]) => {

      // تحميل الأبناء فقط (الذين لديهم parentId)
      this.childCostCenters = res.filter(a => 
        a.type === 'Cost_Centers' && a.parentId
      );

      this.filteredCostCentersList = [...this.childCostCenters];
    },

    error: (err) => console.error('Failed to load cost centers', err)
  });
}

  filteredCostCenters() {
    const filter = this.costCenterFilter.trim().toLowerCase();
    if (!filter) {
      this.filteredCostCentersList = [...this.childCostCenters];
    } else {
      this.filteredCostCentersList = this.childCostCenters.filter(cc =>
        cc.name.toLowerCase().includes(filter) || (cc.code ?? '').toLowerCase().includes(filter)
      );
    }
  }

  // ===== دالة اختيار مركز التكلفة =====
  selectCostCenter(cc: Account) {
    if (this.currentFocus === 'costCenterFrom') {
      this.filterData.costCenterFrom = cc.id.toString();   // خزن الـ id للفلترة
      this.selectedCostCenterNameFrom = cc.name;          // عرض الاسم في الـ textbox
    } else if (this.currentFocus === 'costCenterTo') {
      this.filterData.costCenterTo = cc.id.toString();
      this.selectedCostCenterNameTo = cc.name;
    }

    this.costCenterDialog = false;
    this.filterReport(); // تطبيق الفلترة مباشرة
}




  // ===== حساب المجاميع =====
  calculateTotals() {
    this.totalDebit = this.filteredTransactions.filter(t => t.type === 'مدين').reduce((sum, t) => sum + t.amount, 0);
    this.totalCredit = this.filteredTransactions.filter(t => t.type === 'دائن').reduce((sum, t) => sum + t.amount, 0);
    this.finalBalance = this.totalDebit - this.totalCredit;
    this.avgTransaction = this.filteredTransactions.length
      ? this.filteredTransactions.reduce((sum, t) => sum + t.amount, 0) / this.filteredTransactions.length
      : 0;
  }


  // ===== فتح Dialog عند الضغط على F9 =====
  currentFocus: 'mainAccount' | 'subAccount' | 'costCenterFrom' | 'costCenterTo' | null = null;

@HostListener('window:keydown', ['$event'])
onF9Press(event: KeyboardEvent) {
  if (event.key === 'F9') {
    event.preventDefault();
    this.openLookup(); // هنا بدون type لأن F9 يعتمد على الحقل المحدد
  }
}

focusAndOpen(type: string) {
  // عمل فوكس حسب نوع الحقل
  setTimeout(() => {
    if (type === 'mainAccount') this.mainAccountInput.nativeElement.focus();
    if (type === 'subAccount') this.subAccountInput.nativeElement.focus();
    if (type === 'costCenterFrom') this.costFromInput.nativeElement.focus();
    if (type === 'costCenterTo') this.costToInput.nativeElement.focus();
  });

  // افتح شاشة الـ lookup
  this.openLookup(type);
}


openLookup(type?: string) {
  const lookupType = type || this.currentFocus;

  if (lookupType === 'subAccount') {
    // فقط الحسابات الرئيسية
    this.filteredParentAccounts = this.allParentAccounts.filter(acc => !acc.parentId);
    this.displayAccountDialog = true;
  }

  else if (lookupType === 'mainAccount') {
    // الحسابات الفرعية فقط
    this.filteredParentAccounts = this.flattenChildAccounts(this.accounts);
    this.displayAccountDialog = true;
  }

  else if (lookupType === 'costCenterFrom' || lookupType === 'costCenterTo') {
    this.loadCostCenters();
    this.costCenterDialog = true;
  }
}









// ===== تحميل التقرير من الـ API =====
loadFinancialReportByEntity(filter: JournalFilterDto) {
  if (!filter.contractorId && !filter.centerId && !filter.mainAccountId && !filter.subAccountId) {
    this.messageService.add({ severity: 'warn', summary: 'تحذير', detail: 'حدد على الأقل فلتر واحد' });
    return;
  }

  this.loading = true;
  this.entitiesService.journalFilter(filter).subscribe({
    next: (res: JournalEntryDto[]) => {
      this.transactions = res.map(x => ({
        id: x.journalId,
        mainAccountId: x.accountId,
        accountNumber: x.accountId?.toString() || '',
        accountName: x.description || '',
        date: new Date(x.date),
        type: x.debit > 0 ? 'مدين' : 'دائن',
        amount: x.debit > 0 ? x.debit : x.credit,
        balance: x.balanceAfter,
        costCenterId: x.costCenterId,
        costCenter: this.childCostCenters.find(cc => cc.id === x.costCenterId)?.name || '',
        project: '',
        description: x.description,
        currency: ''
      }));

      this.filteredTransactions = [...this.transactions];
      this.calculateTotals();
      this.loading = false;
    },
    error: () => {
      this.loading = false;
      this.messageService.add({ severity: 'error', summary: 'خطأ', detail: 'فشل تحميل البيانات' });
    }
  });
}

// ===== فلترة التقرير =====
filterReport() {
  const fromId = this.filterData.costCenterFrom;
  const toId = this.filterData.costCenterTo;

  let selectedCostCenters: string[] = [];

  if (fromId && toId) {
    const fromIndex = this.childCostCenters.findIndex(cc => cc.id.toString() === fromId);
    const toIndex = this.childCostCenters.findIndex(cc => cc.id.toString() === toId);
    if (fromIndex > -1 && toIndex > -1) {
      const start = Math.min(fromIndex, toIndex);
      const end = Math.max(fromIndex, toIndex);
      selectedCostCenters = this.childCostCenters.slice(start, end + 1).map(cc => cc.id.toString());
    }
  } else if (fromId) {
    selectedCostCenters = [fromId];
  } else if (toId) {
    selectedCostCenters = [toId];
  }

  this.filteredTransactions = this.transactions.filter(t => {
    const matchAccount =
      (!this.filterData.accountNumber || t.accountNumber.includes(this.filterData.accountNumber)) &&
      (!this.filterData.accountName || t.accountName.toLowerCase().includes(this.filterData.accountName.toLowerCase()));

    const matchCostCenter = selectedCostCenters.length === 0 || selectedCostCenters.includes(t.costCenterId?.toString() || '');

    const matchDate =
      (!this.filterData.startDate || new Date(t.date) >= new Date(this.filterData.startDate)) &&
      (!this.filterData.endDate || new Date(t.date) <= new Date(this.filterData.endDate));

    const matchType = !this.filterData.transactionType || t.type === this.filterData.transactionType;
    const matchProject = !this.filterData.project || (t.project?.toLowerCase().includes(this.filterData.project.toLowerCase()));
    const matchCurrency = !this.filterData.currency || t.currency === this.filterData.currency;

    return matchAccount && matchCostCenter && matchDate && matchType && matchProject && matchCurrency;
  });

  this.calculateTotals();
}


// ===== تطبيق اختيار الحساب =====
applyAccountFilter() {
  if (!this.selectedParentAccount && !this.selectedMainAccount && !this.selectedSubAccount) {
    this.messageService.add({ severity: 'warn', summary: 'تحذير', detail: 'حدد على الأقل حساب واحد' });
    return;
  }

  const filter: JournalFilterDto = {
    contractorId: this.selectedParentAccount?.id || 0,
    centerId: 0,
    costCenterFrom: this.filterData.costCenterFrom ? +this.filterData.costCenterFrom : 0,
    costCenterTo: this.filterData.costCenterTo ? +this.filterData.costCenterTo : 0,
    mainAccountId: this.selectedMainAccount?.id || 0,
    subAccountId: this.selectedSubAccount?.id || 0
  };

  this.displayAccountDialog = false;
  this.loadFinancialReportByEntity(filter);
}


// ===== تطبيق الفلترة المحلية =====
applyLocalFilters() {
  this.filteredTransactions = this.transactions.filter(tx => {
    const matchProject = !this.filterData.project || tx.project?.toLowerCase().includes(this.filterData.project.toLowerCase());
    const matchCurrency = !this.filterData.currency || tx.currency === this.filterData.currency;
    const matchType = !this.filterData.transactionType || tx.type === this.filterData.transactionType;
    const matchStartDate = !this.filterData.startDate || tx.date >= new Date(this.filterData.startDate);
    const matchEndDate = !this.filterData.endDate || tx.date <= new Date(this.filterData.endDate);
    const matchCostCenterFrom = !this.filterData.costCenterFrom || (tx.costCenterId != null && tx.costCenterId >= +this.filterData.costCenterFrom);
    const matchCostCenterTo = !this.filterData.costCenterTo || (tx.costCenterId != null && tx.costCenterId <= +this.filterData.costCenterTo);

    return matchProject && matchCurrency && matchType && matchStartDate && matchEndDate && matchCostCenterFrom && matchCostCenterTo;
  });

  this.calculateTotals();
}





onGlobalFilter(event: Event) {
    const input = event.target as HTMLInputElement;
    this.dt.filterGlobal(input.value, 'contains');
}



selectParentAccount(account: Account) {
    if (this.currentFocus === 'mainAccount') {
      this.filterData.mainAccount = account.name; // فقط للحساب الرئيسي
      this.filterData.mainAccountId = account.id; // اختياري لو تريد تخزين الرقم
    }
    else if (this.currentFocus === 'subAccount') {
      this.filterData.accountName = account.name; // فقط للحساب الفرعي
      this.filterData.accountNumber = account.id.toString();
    }

    this.selectedParentAccount = account;

    this.displayAccountDialog = false; // غلق الـ dialog بعد الاختيار
}



  onRowSelect(tx: Transaction | Transaction[] | null | undefined) {
    if (!tx) return;
    this.selectedTransaction = Array.isArray(tx) ? tx[0] : tx;
    this.displayDialog = true;
  }

  // ===== التصدير =====
  exportToPDF() {
    const doc = new jsPDF('p', 'mm', 'a4');
    doc.setFontSize(14);
    doc.text('تقرير الحركات المالية', 200 - 14, 10, { align: 'right' });

    const bodyData = this.filteredTransactions.map(x => [
      x.accountNumber, x.accountName, x.date.toLocaleDateString('ar-EG'),
      x.type, x.amount.toFixed(2), x.balance.toFixed(2),
      x.costCenter || '', x.project || '', x.description || '', x.currency || ''
    ]);

    autoTable(doc, {
      head: [['رقم الحساب', 'اسم الحساب', 'التاريخ', 'نوع الحركة', 'المبلغ', 'الرصيد', 'مركز التكلفة', 'المشروع', 'الوصف', 'العملة']],
      body: bodyData,
      startY: 20,
      styles: { halign: 'right', font: 'helvetica' },
      headStyles: { halign: 'center', fillColor: [41, 128, 185], textColor: 255 },
      theme: 'grid'
    });

    const finalY = (doc as any).lastAutoTable?.finalY || 20;
    doc.text(`إجمالي المدين: ${this.totalDebit.toFixed(2)}`, 200 - 14, finalY + 10, { align: 'right' });
    doc.text(`إجمالي الدائن: ${this.totalCredit.toFixed(2)}`, 200 - 14, finalY + 20, { align: 'right' });
    doc.text(`الرصيد النهائي: ${this.finalBalance.toFixed(2)}`, 200 - 14, finalY + 30, { align: 'right' });

    doc.save('financial-report.pdf');
  }

  exportExcel() {
    const worksheet = XLSX.utils.json_to_sheet(this.filteredTransactions);
    const workbook = { Sheets: { 'تقرير الحركات': worksheet }, SheetNames: ['تقرير الحركات'] };
    XLSX.writeFile(workbook, 'financial-report.xlsx');
  }

  exportCSV() {
    const worksheet = XLSX.utils.json_to_sheet(this.filteredTransactions);
    const csv = XLSX.utils.sheet_to_csv(worksheet);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'financial-report.csv';
    link.click();
  }
}






/* ===============================
   Toast Container
================================ */
.custom-toast {
  direction: rtl; /* دعم RTL */
}

/* ===============================
   Toast Message (Base)
================================ */
.custom-toast .p-toast-message {
  position: relative;
  background-color: #ffffff;
  color: #374151;
  border-radius: 10px;
  padding: 14px 16px 14px 20px;
  margin: 0 0 12px 0;
  border: none;
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: 'Inter', 'Segoe UI', Tahoma, Arial, sans-serif;
}

/* ===============================
   Sidebar Indicator
================================ */
.custom-toast .p-toast-message::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;              /* RTL */
  width: 6px;
  height: 100%;
  background-color: #ef4444;
  border-radius: 0 10px 10px 0;
}

/* ===============================
   Progress Bar (Timeout)
================================ */
.custom-toast .p-toast-message::after {
  content: '';
  position: absolute;
  bottom: 0;
  right: 6px;            /* بعد الشريط الجانبي */
  height: 3px;
  width: calc(100% - 6px);
  background-color: rgba(0, 0, 0, 0.12);
  animation: toastProgress 3s linear forwards;
}

@keyframes toastProgress {
  from {
    width: calc(100% - 6px);
  }
  to {
    width: 0;
  }
}

/* ===============================
   Toast Types
================================ */

/* Error */
.custom-toast .p-toast-message-error::before {
  background-color: #ef4444;
}

/* Success */
.custom-toast .p-toast-message-success::before {
  background-color: #22c55e;
}

/* Info */
.custom-toast .p-toast-message-info::before {
  background-color: #3b82f6;
}

/* Warn */
.custom-toast .p-toast-message-warn::before {
  background-color: #f59e0b;
}

/* ===============================
   Title & Message
================================ */
.custom-toast .p-toast-summary {
  font-weight: 600;
  font-size: 14px;
  color: #111827;
}

.custom-toast .p-toast-detail {
  font-size: 13px;
  color: #6b7280;
  margin-top: 2px;
}

/* ===============================
   Icon
================================ */
.custom-toast .p-toast-message-icon {
  font-size: 18px;
  margin-left: 6px;
  color: inherit;
}

/* ===============================
   Close Button
================================ */
.custom-toast .p-toast-icon-close {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #9ca3af;
  transition: color 0.2s ease;
}

.custom-toast .p-toast-icon-close:hover {
  color: #111827;
}
